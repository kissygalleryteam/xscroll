KISSY.add("kg/xscroll/3.0.0/plugins/infinite",["../util","../base"],function(e,i,t,n){var s=i("../util"),r=i("../base"),l=s.prefixStyle("transform"),o=s.prefixStyle("transition"),a=function(e){a.superclass.constructor.call(this,e),this.userConfig=s.mix({zoomType:"y",transition:"all 0.5s ease"},e)};s.extend(a,r,{pluginId:"infinite",visibleElements:{},pluginInitializer:function(e){var i=this;return i.xscroll=e,i.isY=!("y"!=i.userConfig.zoomType),i._nameTop=i.isY?"_top":"_left",i._nameHeight=i.isY?"_height":"_width",i.nameTop=i.isY?"top":"left",i.nameHeight=i.isY?"height":"width",i.nameWidth=i.isY?"width":"height",i.nameY=i.isY?"y":"x",i.nameTranslate=i.isY?"translateY":"translateX",i.nameContainerHeight=i.isY?"containerHeight":"containerWidth",i.nameScrollTop=i.isY?"scrollTop":"scrollLeft",i._initInfinite(),e.on("afterrender",function(){i.render(),i._bindEvt()}),i},pluginDestructor:function(){var e=this;e.xscroll.off("scroll",e._updateByScroll,e);for(var i=0;i<e.infiniteLength;i++)e.infiniteElements[i].style.position="inherit",e.infiniteElements[i].style.visibility="inherit",e.infiniteElements[i].style.display="inherit",e.infiniteElements[i].style[e.nameTop]="auto",e.infiniteElements[i].style[l]="none";return e.xscroll.off("tap panstart pan panend",e._cellEventsHandler,e),e._destroySticky(),e},_initInfinite:function(){var e=this,i=e.xscroll;return e.sections={},e.infiniteElements=i.renderTo.querySelectorAll(e.userConfig.infiniteElements),e.infiniteLength=e.infiniteElements.length,e.infiniteElementsCache=function(){for(var i=[],t=0;t<e.infiniteLength;t++)i.push({}),e.infiniteElements[t].style.position="absolute",e.infiniteElements[t].style[e.nameTop]=0,e.infiniteElements[t].style.visibility="hidden",e.infiniteElements[t].style.display="block",s.addClass(e.infiniteElements[t],"_xs_infinite_elements_");return i}(),e.elementsPos={},i.on("scroll",e._updateByScroll,e),e},_initSticky:function(){var e=this;if(e.stickyDomInfo=[],e.hasSticky){if(!e._isStickyRendered){var i=document.createElement("div");i.style.position="fixed",i.style.left=0,i.style.top=0,i.style.display="none",s.addClass(i,"_xs_infinite_elements_"),e.xscroll.renderTo.appendChild(i),e.stickyElement=i,e._isStickyRendered=!0}for(var t in e.__serializedData){var i=e.__serializedData[t];i&&i.style&&"sticky"==i.style.position&&e.stickyDomInfo.push(i)}return e}},_destroySticky:function(){var e=this;return e.hasSticky=!1,e.stickyElement&&e.stickyElement.remove(),e._isStickyRendered=!1,e},_renderUnRecycledEl:function(){var e=this,i=e.userConfig.gpuAcceleration?" translateZ(0) ":"";for(var t in e.__serializedData){var n=e.__serializedData[t];if(e.__serializedData[t].recycled===!1){var r=n.id&&document.getElementById(n.id.replace("#",""))||document.createElement("div"),o=s.guid("xs-row-");r.id=n.id||o,n.id=r.id,e.xscroll.content.appendChild(r);for(var a in n.style)a!=e.nameHeight&&"display"!=a&&"position"!=a&&(r.style[a]=n.style[a]);r.style[e.nameTop]=0,r.style.position="absolute",r.style.display="block",r.style[e.nameHeight]=n[e._nameHeight]+"px",r.style[l]=e.nameTranslate+"("+n[e._nameTop]+"px) "+i,s.addClass(r,n.className),e.userConfig.renderHook.call(e,r,n)}}},render:function(){var e=this,i=e.xscroll,t=e.isY?i.getScrollTop():i.getScrollLeft();e.visibleElements=e.getVisibleElements(t),e.__serializedData=e._computeDomPositions(),e._initSticky();var n=i[e.nameHeight],s=e._containerSize;return n>s&&(s=n),i[e.nameContainerHeight]=s,i.container.style[e.nameHeight]=s+"px",i.content.style[e.nameHeight]=s+"px",e.curStickyIndex=void 0,e._renderUnRecycledEl(),e._updateByScroll(),e._updateByRender(t),e.xscroll.boundryCheck(),e},_getChangedRows:function(e){var i=this,t={};for(var n in i.elementsPos)e.hasOwnProperty(n)||(t[n]="delete");for(var n in e)e[n].recycled&&!i.elementsPos.hasOwnProperty(n)&&(t[n]="add");return i.elementsPos=e,t},_updateByScroll:function(e){var i=this,t=i.xscroll,n=e&&e[i.nameScrollTop],s=void 0===n?i.isY?t.getScrollTop():t.getScrollLeft():n,r=i.getVisibleElements(s),l=i._getChangedRows(r);for(var o in l)if("delete"==l[o]&&i._pushEl(o),"add"==l[o]){var a=i._popEl(r[o][i.guid]),c=a.index,d=a.el;d&&(i.infiniteElementsCache[c].guid=r[o].guid,i.__serializedData[r[o].guid].__infiniteIndex=c,i._renderData(d,r[o]),i._renderStyle(d,r[o]))}return i._stickyHandler(s),i},_updateByRender:function(e){var i,t,n=this,s=n.xscroll,e=void 0===e?n.isY?s.getScrollTop():s.getScrollLeft():e,r=n.visibleElements,l=n.getVisibleElements(e);for(var o in l){t=l[o];for(var a in r)if(i=r[a],i.guid===t.guid)(t.style!=i.style||t[n._nameTop]!=i[n._nameTop]||t[n._nameHeight]!=i[n._nameHeight])&&n._renderStyle(n.infiniteElements[t.__infiniteIndex],t,!0),JSON.stringify(t.data)!=JSON.stringify(i.data)&&n._renderData(n.infiniteElements[t.__infiniteIndex],t);else if(void 0===n.__serializedData[t.guid].__infiniteIndex){var c=n._popEl();n.__serializedData[t.guid].__infiniteIndex=c.index,n._renderData(c.el,t),n._renderStyle(c.el,t)}}n.visibleElements=l},_stickyHandler:function(e){var i=this;e=void 0===e?i.isY?i.xscroll.getScrollTop():i.xscroll.getScrollLeft():e;for(var t=Math.abs(e),n=[],r=[],o=0;o<i.stickyDomInfo.length;o++)r.push(i.stickyDomInfo[o][i._nameTop]),t>=i.stickyDomInfo[o][i._nameTop]&&n.push(o);if(!n.length)return i.stickyElement&&(i.stickyElement.style.display="none"),void(i.curStickyIndex=void 0);var a=Math.max.apply(null,n);if(i.curStickyIndex!==a){i.curStickyIndex=a,i.userConfig.renderHook.call(i,i.stickyElement,i.stickyDomInfo[i.curStickyIndex]),i.stickyElement.style.display="block",i.stickyElement.style[i.nameWidth]="100%",i.stickyElement.style[i.nameHeight]=i.stickyDomInfo[i.curStickyIndex].style[i.nameHeight]+"px",i.stickyElement.setAttribute("xs-guid",i.stickyDomInfo[i.curStickyIndex].guid),s.addClass(i.stickyElement,i.stickyDomInfo[i.curStickyIndex].className);for(var c in i.stickyDomInfo[i.curStickyIndex].style)c!=i.nameHeight&&"display"!=c&&"position"!=c&&(i.stickyElement.style[c]=i.stickyDomInfo[i.curStickyIndex].style[c])}var d=0;if(i.stickyDomInfo[i.curStickyIndex+1]){var f=i.stickyDomInfo[i.curStickyIndex],y=i.stickyDomInfo[i.curStickyIndex+1];d=e+f[i._nameHeight]>y[i._nameTop]&&e+f[i._nameHeight]<y[i._nameTop]+f[i._nameHeight]?f[i._nameHeight]+t-y[i._nameTop]:0}return i.stickyElement.style[l]=i.isY?"translateY(-"+d+"px) translateZ(0)":"translateX(-"+d+"px) translateZ(0)",e<Math.min.apply(null,r)?(i.stickyElement.style.display="none",void(i.curStickyIndex=void 0)):void 0},_computeDomPositions:function(){var e,i=this,t=0,n=0,r=i.sections;i.hasSticky=!1;var l=[],o={};for(var a in r)for(var c=0,d=r[a].length;d>c;c++)e=r[a][c],e.sectionId=a,e.index=c,l.push(e);i.userConfig.maxSpeed=3;for(var a=0,f=l.length;f>a;a++){var y=l[a];n=y.style&&y.style[i.nameHeight]>=0?y.style[i.nameHeight]:100,y.guid=y.guid||s.guid(),y[i._nameTop]=t,y[i._nameHeight]=n,y.recycled=y.recycled===!1?!1:!0,t+=n,!i.hasSticky&&y.style&&"sticky"==y.style.position&&(i.hasSticky=!0),o[y.guid]=y}return i._containerSize=t,o},getVisibleElements:function(e){var i,t=this,n=t.xscroll,e=void 0===e?t.isY?n.getScrollTop():n.getScrollLeft():e,s=50,r=Math.ceil(n[t.nameHeight]/s),l=void 0===t.userConfig.maxBufferedNum?Math.max(Math.ceil(r/3),1):t.userConfig.maxBufferedNum,e=Math.max(e-l*s,0),o={},a=t.__serializedData;for(var c in a)i=a[c],i[t._nameTop]>=e-s&&i[t._nameTop]<=e+2*l*s+n[t.nameHeight]&&(o[i.guid]=i);return JSON.parse(JSON.stringify(o))},_popEl:function(){for(var e=this,i=0;i<e.infiniteLength;i++)if(!e.infiniteElementsCache[i]._visible)return e.infiniteElementsCache[i]._visible=!0,{index:i,el:e.infiniteElements[i]}},_pushEl:function(e){for(var i=this,t=0;t<i.infiniteLength;t++)i.infiniteElementsCache[t].guid==e&&(i.infiniteElementsCache[t]._visible=!1,i.infiniteElements[t].style.visibility="hidden",delete i.infiniteElementsCache[t].guid)},_renderData:function(e,i){var t=this;e&&t.userConfig.renderHook.call(t,e,i)},_renderStyle:function(e,i,t){var n=this;if(e){var s=n.xscroll.userConfig.gpuAcceleration?" translateZ(0) ":"",r={color:"inherit",background:"inherit",margin:"inherit",padding:"inherit",opacity:"inherit",textIndent:"inherit",overflow:"inherit"};for(var a in r)e.style[a]=r[a];for(var a in i.style)a!=n.nameHeight&&"display"!=a&&"position"!=a&&(e.style[a]=i.style[a]);e.setAttribute("xs-index",i.index),e.setAttribute("xs-sectionid",i.sectionId),e.setAttribute("xs-guid",i.guid),e.style.visibility="visible",e.style[n.nameHeight]=i[n._nameHeight]+"px",e.style[l]=n.nameTranslate+"("+i[n._nameTop]+"px) "+s,e.style[o]=t?n.userConfig.transition:"none"}},getCell:function(e){var i=this,t=s.findParentEl(e.target,"._xs_infinite_elements_",i.xscroll.renderTo),n=t.getAttribute("xs-guid");return void 0!==n?i.__serializedData[n]:void 0},_bindEvt:function(){var e=this;if(!e._isEvtBinded)return e._isEvtBinded=!0,e.xscroll.renderTo.addEventListener("webkitTransitionEnd",function(e){e.target.className.match(/xs-row/)&&(e.target.style.webkitTransition="")}),e.xscroll.on("tap panstart pan panend",e._cellEventsHandler,e),e},_cellEventsHandler:function(e){var i=this;e.cell=i.getCell(e),e.cell&&i[e.type].call(i,e)},tap:function(e){return this.trigger("tap",e),this},panstart:function(e){return this.trigger("panstart",e),this},pan:function(e){return this.trigger("pan",e),this},panend:function(e){return this.trigger("panend",e),this},insertBefore:function(e,i,t){var n=this;return void 0===e||void 0===i||void 0===t?n:(n.sections[e]||(n.sections[e]=[]),n.sections[e].splice(i,0,t),n)},insertAfter:function(e,i,t){var n=this;return void 0===e||void 0===i||void 0===t?n:(n.sections[e]||(n.sections[e]=[]),n.sections[e].splice(Number(i)+1,0,t),n)},append:function(e,i){var t=this;return t.sections[e]||(t.sections[e]=[]),t.sections[e]=t.sections[e].concat(i),t},remove:function(e,i,t){var n=this,t=t||1;return void 0!==e&&n.sections[e]?void 0===i?(delete n.sections[e],n):n.sections[e]&&n.sections[e][i]?(n.sections[e].splice(i,t),n):n:n},replace:function(e,i,t){var n=this;return void 0!==e&&n.sections[e]?(n.sections[e][i]=t,n):n},get:function(e,i){return void 0!==e?void 0===i?this.sections[e]:this.sections[e][i]:void 0}}),"object"==typeof n&&n.exports?n.exports=a:window.XScroll&&window.XScroll.Plugins&&(XScroll.Plugins.Infinite=a)});